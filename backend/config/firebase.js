const admin = require('firebase-admin');

// Configura√ß√£o do Firebase Admin
let privateKey = process.env.FIREBASE_PRIVATE_KEY;

console.log('üîç DEBUG - Vari√°veis Firebase dispon√≠veis:');
console.log('- FIREBASE_PROJECT_ID:', process.env.FIREBASE_PROJECT_ID ? '‚úÖ Existe' : '‚ùå N√£o existe');
console.log('- FIREBASE_PRIVATE_KEY:', process.env.FIREBASE_PRIVATE_KEY ? '‚úÖ Existe' : '‚ùå N√£o existe');
console.log('- FIREBASE_SERVICE_ACCOUNT_JSON:', process.env.FIREBASE_SERVICE_ACCOUNT_JSON ? '‚úÖ Existe' : '‚ùå N√£o existe');
console.log('- FIREBASE_CLIENT_EMAIL:', process.env.FIREBASE_CLIENT_EMAIL ? '‚úÖ Existe' : '‚ùå N√£o existe');

// Tentar diferentes formata√ß√µes da chave privada
if (privateKey) {
  // Remover escapes duplos e simples
  privateKey = privateKey.replace(/\\\\n/g, '\n').replace(/\\n/g, '\n');
  
  // Se n√£o come√ßar com BEGIN, pode estar mal formatada
  if (!privateKey.includes('-----BEGIN PRIVATE KEY-----')) {
    console.error('‚ùå Chave privada n√£o parece estar no formato correto');
    console.log('üîç Primeiros 100 caracteres:', privateKey.substring(0, 100));
  } else {
    console.log('‚úÖ Chave privada parece estar no formato correto');
  }
}

let serviceAccount;
if (process.env.FIREBASE_SERVICE_ACCOUNT_JSON) {
  // Ambiente Render/produ√ß√£o: carrega do JSON da vari√°vel de ambiente
  serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON);
} else {
  // Ambiente local: carrega do arquivo

  serviceAccount = {
    type: "service_account",
    project_id: process.env.FIREBASE_PROJECT_ID,
    private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
    private_key: privateKey,
    client_email: process.env.FIREBASE_CLIENT_EMAIL,
    client_id: process.env.FIREBASE_CLIENT_ID,
    auth_uri: "https://accounts.google.com/o/oauth2/auth",
    token_uri: "https://oauth2.googleapis.com/token",
  auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
    client_x509_cert_url: `https://www.googleapis.com/robot/v1/metadata/x509/${process.env.FIREBASE_CLIENT_EMAIL}`
  };
}

// Inicializar Firebase Admin apenas se ainda n√£o foi inicializado
if (!admin.apps.length) {
  // Tentar m√©todo JSON primeiro (mais confi√°vel)
  if (process.env.FIREBASE_SERVICE_ACCOUNT_JSON) {
    try {
      console.log('üîÑ Tentando inicializar com JSON completo...');
      const serviceAccountFromJSON = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON);
      admin.initializeApp({
        credential: admin.credential.cert(serviceAccountFromJSON),
        databaseURL: `https://${process.env.FIREBASE_PROJECT_ID}-default-rtdb.firebaseio.com`
      });
      console.log('‚úÖ Firebase inicializado com sucesso usando JSON completo');
    } catch (jsonError) {
      console.error('‚ùå Erro com JSON:', jsonError.message);
      console.log('üîÑ Tentando com vari√°veis individuais...');
      
      try {
        admin.initializeApp({
          credential: admin.credential.cert(serviceAccount),
          databaseURL: `https://${process.env.FIREBASE_PROJECT_ID}-default-rtdb.firebaseio.com`
        });
        console.log('‚úÖ Firebase inicializado com sucesso usando vari√°veis individuais');
      } catch (individualError) {
        console.error('‚ùå Erro final com vari√°veis individuais:', individualError.message);
        throw individualError;
      }
    }
  } else {
    console.log('‚ùå FIREBASE_SERVICE_ACCOUNT_JSON n√£o encontrada, usando vari√°veis individuais...');
    try {
      admin.initializeApp({
        credential: admin.credential.cert(serviceAccount),
        databaseURL: `https://${process.env.FIREBASE_PROJECT_ID}-default-rtdb.firebaseio.com`
      });
      console.log('‚úÖ Firebase inicializado com sucesso usando vari√°veis individuais');
    } catch (error) {
      console.error('‚ùå Erro final:', error.message);
      throw error;
    }
  }
}

module.exports = admin;
